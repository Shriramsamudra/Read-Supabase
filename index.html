<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Supabase Data Reader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body class="min-h-screen bg-gray-100 dark:bg-gray-900 font-sans p-4 sm:p-8 flex flex-col items-center">

  <div class="w-full max-w-6xl">
    <header class="text-center py-8">
      <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white">
        Supabase Data Reader
      </h1>
      <p class="mt-2 text-lg text-gray-600 dark:text-gray-400">
        Fetching records from <code>contacts</code>, <code>onboarding_data</code>, and <code>risk_appetite_reports</code>
      </p>
    </header>

    <div id="data-sections" class="flex flex-col md:flex-row space-y-8 md:space-y-0 md:space-x-8">
      <div class="w-full text-center text-lg text-gray-600 dark:text-gray-400" id="loading">
        <p>Loading...</p>
      </div>
    </div>

    <div class="flex justify-center mt-8">
      <button
        id="refreshBtn"
        class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-full shadow-lg hover:bg-blue-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
      >
        Refresh Data
      </button>
    </div>
  </div>

  <script>
    // Supabase Config
    const supabaseUrl = 'https://uynntgocoxdrzdqumlwfe.supabase.co'; // Note: I corrected the typo in the URL from your previous file (uynt... to uynnt...) based on the standard format, but if your previous URL was working, please verify. The React code had 'uynntgocoxdrzdqumlwfe'.
    // Assuming the React code key was the correct one:
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5bnRnb2NveGRyemRxdW1sd2ZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzczMDMsImV4cCI6MjA3MDc1MzMwM30.xWK9IeeJcWqp-gaDR2yO_hqscAsVgbJQ5sxTo2AUvfU';
    
    const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

    // Helper: Format Date to show Month Name (e.g., January 1, 2024)
    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      // Check if date is valid
      if (isNaN(date.getTime())) return dateString;
      
      // Returns format like "January 15, 1990"
      return date.toLocaleDateString('en-US', {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
      });
    }

    // Try to guess the best column for ordering
    function getOrderColumn(data) {
      if (!data || data.length === 0) return null;
      const sample = data[0];
      if ('created_at' in sample) return 'created_at';
      if ('timestamp' in sample) return 'timestamp';
      if ('id' in sample) return 'id';
      // fallback: pick the first property
      return Object.keys(sample)[0];
    }

    // Helper to render questionnaire JSON
    function renderQuestionnaire(questionnaire) {
      if (!questionnaire) return '';
      let parsed;
      try {
        parsed = typeof questionnaire === 'string' ? JSON.parse(questionnaire) : questionnaire;
      } catch (e) {
        return '<span class="text-red-500">Invalid JSON</span>';
      }
      if (typeof parsed !== 'object' || parsed === null) return '';
      return `
        <pre class="bg-gray-200 dark:bg-gray-900 rounded p-2 overflow-x-auto text-xs mt-1">
${JSON.stringify(parsed, null, 2)}
        </pre>
      `;
    }

    // Render a card with latest row highlighted
    function renderCard(title, data, options = {}) {
      let content = '';
      if (data.length > 0) {
        content = data.map((item, idx) => {
          const isLatest = idx === 0;
          const highlight = isLatest
            ? 'border-2 border-blue-500 bg-blue-100 dark:bg-blue-900'
            : 'border border-gray-100 dark:border-gray-600';
          
          const props = Object.entries(item).map(([key, value]) => {
            // 1. Handle explicit special renderers (like questionnaire)
            if (options.special && options.special[key]) {
              return `
                <div class="mb-2">
                  <span class="font-medium capitalize text-gray-800 dark:text-gray-200">${key}:</span>
                  ${options.special[key](value)}
                </div>
              `;
            }

            // 2. Handle Date of Birth fields automatically
            let displayValue = value;
            // Regex checks for "dob" or "birth" in the key name (case insensitive)
            if (/dob|birth/i.test(key) && value) {
                displayValue = formatDate(value);
            } else {
                // Default display logic
                displayValue = (value !== null && typeof value === 'object')
                  ? '<span class="italic text-gray-500">[object]</span>'
                  : String(value);
            }

            return `
              <p class="text-sm text-gray-700 dark:text-gray-300">
                <span class="font-medium capitalize text-gray-800 dark:text-gray-200">${key}:</span>
                ${displayValue}
              </p>
            `;
          }).join('');

          return `
            <div class="p-4 rounded-xl ${highlight} mb-2">
              ${isLatest ? `<span class="inline-block mb-2 px-2 py-1 bg-blue-500 text-white text-xs rounded">Latest</span>` : ''}
              ${props}
            </div>
          `;
        }).join('');
      } else {
        content = `<p class="text-center text-gray-500 dark:text-gray-400">No data available.</p>`;
      }
      return `
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 flex-1">
          <h3 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">${title}</h3>
          <div class="space-y-4">${content}</div>
        </div>
      `;
    }

    // Try to get table data ordered by most recent, using best effort for order column
    async function fetchOrderedTable(tableName) {
      // First, get a sample row to guess order column
      let { data: sampleData, error: sampleErr } = await supabase
        .from(tableName)
        .select('*')
        .limit(1);
      if (sampleErr) throw sampleErr;
      const orderCol = getOrderColumn(sampleData || []);
      // Default: show as is if no orderCol found
      if (!orderCol) {
        let { data, error } = await supabase.from(tableName).select('*');
        if (error) throw error;
        return data || [];
      }
      // Try to order descending (latest first)
      let { data, error } = await supabase
        .from(tableName)
        .select('*')
        .order(orderCol, { ascending: false });
      if (error) throw error;
      return data || [];
    }

    // Fetch and render all tables
    async function fetchData() {
      document.getElementById('data-sections').innerHTML = `
        <div class="w-full text-center text-lg text-gray-600 dark:text-gray-400" id="loading">
          <p>Loading...</p>
        </div>
      `;
      try {
        // Fetch with latest first and highlight
        const [contacts, onboarding, riskAppetite] = await Promise.all([
          fetchOrderedTable('contacts'),
          fetchOrderedTable('onboarding_data'),
          fetchOrderedTable('risk_appetite_reports')
        ]);
        document.getElementById('data-sections').innerHTML = `
          ${renderCard('Contacts', contacts)}
          ${renderCard('Onboarding Data', onboarding)}
          ${renderCard('Risk Appetite Reports', riskAppetite, {
            special: { questionnaire: renderQuestionnaire }
          })}
        `;
      } catch (err) {
        document.getElementById('data-sections').innerHTML = `
          <div class="w-full text-center text-lg text-red-500">
            <p>Failed to fetch data.<br>${err.message}</p>
          </div>
        `;
        console.error(err);
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', fetchData);

    // Initial load
    fetchData();
  </script>
</body>
</html>